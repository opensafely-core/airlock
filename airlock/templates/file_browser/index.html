{% extends "base.html" %}

{% load static %}
{% load django_vite %}
{% load django_htmx %}

{% block metatitle %}{{ title }} |  Airlock{% endblock metatitle %}

{% block extra_styles %}
  <link rel="stylesheet" href="{% static 'assets/file_browser/index.css' %}">
{% endblock extra_styles %}

{% block content %}
  {% if context == "request" %}
    {% #airlock_header context=context release_request=release_request title=title workspace=workspace %}
      {% if is_author %}
        {% if release_request.status_owner.name == "AUTHOR" %}
          <form action="{{ request_submit_url }}" method="POST">
            {% csrf_token %}
            {% #button type="submit" tooltip="This request is ready to be reviewed" variant="success" class="action-button btn-sm" id="submit-for-review-button" %}Submit for review{% /button %}
          </form>
          {% #modal id="withdrawRequest" button_text="Withdraw this request" variant="warning" %}
            {% #card container=True title="Withdraw this request" %}
              <form action="{{ request_withdraw_url }}" method="POST">
                {% csrf_token %}

                <div class="pb-8">
                  This will withdraw the entire request.
                  Once a request is withdrawn, it cannot be resubmitted and must be
                  recreated from scratch.
                  Please confirm you wish to withdraw this request.
                </div>
                {% #button type="submit" variant="danger" class="action-button btn-sm" id="withdraw-request-confirm" %}Withdraw{% /button %}
                {% #button variant="primary" type="cancel" %}Cancel{% /button %}
              </form>
            {% /card %}
          {% /modal %}
        {% endif %}
      {% elif is_output_checker %}
        {% if release_request.status_owner.name == "REVIEWER" %}
          {% comment %} A fully reviewed request can be returned or rejected {% endcomment %}
          {% if release_request.status.name == "REVIEWED" %}
            <form action="{{ request_reject_url }}" method="POST">
              {% csrf_token %}
              {% #button type="submit" variant="danger" class="action-button btn-sm" id="reject-request-button" %}Reject request{% /button %}
            </form>
            <form action="{{ request_return_url }}" method="POST" hx-post="{{ request_return_url }}" hx-disabled-elt="button">
              {% csrf_token %}
              {% #button type="submit" class="btn-sm" tooltip="Return request for changes/clarification" variant="secondary" id="return-request-button" %}Return request{% /button %}
            </form>
          {% else %}
            {% #button disabled=True class="relative group btn-sm" variant="danger" id="reject-request-button" %}
              Reject request
              {% tooltip class="airlock-tooltip" content="Rejecting a request is disabled until review has been completed by two reviewers" %}
            {% /button %}
            {% #button disabled=True class="relative group btn-sm" variant="secondary" id="return-request-button" %}
              Return request
              {% tooltip class="airlock-tooltip" content="Returning a request is disabled until review has been completed by two reviewers" %}
            {% /button %}
          {% endif %}
          {% comment %} User can complete review if they haven't already {% endcomment %}
          {% if user_has_completed_review %}
            {% #button disabled=True class="relative group btn-sm" variant="secondary" id="complete-review-button" %}
              Complete review
              {% tooltip class="airlock-tooltip" content="You have already completed your review" %}
            {% /button %}
          {% elif user_has_reviewed_all_files %}
            <form action="{{ request_review_url }}" method="POST">
              {% csrf_token %}
              {% #button type="submit" class="btn-sm" tooltip="Complete Review" variant="secondary" id="complete-review-button" %}Complete review{% /button %}
            </form>
          {% else %}
            {% #button disabled=True class="relative group btn-sm" variant="secondary" id="complete-review-button" %}
              Complete review
              {% tooltip class="airlock-tooltip" content="You must review all files before you can complete your review" %}
            {% /button %}
          {% endif %}
        {% endif %}
        {% comment %} A fully reviewed or approved request can be released if all its files are also approved {% endcomment %}
        {% if release_request.can_be_released %}
          <form action="{{ release_files_url }}" method="POST" hx-post="{{ release_files_url }}" hx-disabled-elt="button">
            {% csrf_token %}
            {% #button class="btn-sm" type="submit" tooltip="Release files to jobs.opensafely.org" variant="warning" id="release-files-button" %}
              Release files
              <img height="16" width="16" class="icon icon--green-700 animate-spin htmx-indicator" src="{% static 'icons/progress_activity.svg' %}" alt="">
            {% /button %}
          </form>
        {% elif release_request.status_owner.name == "REVIEWER" %}
          {% #button disabled=True class="relative group btn-sm" variant="warning" id="release-files-button" %}
            Release files
            {% tooltip class="airlock-tooltip" content="Releasing to jobs.opensafely.org is disabled until all files have been approved by by two reviewers" %}
          {% /button %}
        {% endif %}
      {% endif %}
    {% /airlock_header %}
  {% else %}
    {% #airlock_header context=context current_request=current_request title=title workspace=workspace return_url=return_url %}
    {% /airlock_header %}
  {% endif %}

{% endblock content %}

{% block full_width_content %}
  <div class="browser">
    <div class="browser__files">
      <ul
        class="tree root tree__root"
        {% if is_author %}data-author="true"{% endif %}
        {% if is_output_checker %}data-output-checker="true"{% endif %}
        {% if context == "request" %}data-request="true"{% endif %}
        {% if release_request.status.name %}data-request-status="{{ release_request.status.name }}"{% endif %}
        {% if context != "request" %}data-workspace="true"{% endif %}
        {% if release_request.all_files_reviewed %}data-all-files-reviewed="true"{% endif %}
        {% if release_request.all_files_approved %}data-all-files-approved="true"{% endif %}
        hx-boost="true"
        hx-on:htmx:after-request="setTreeSelection(this, event)"
        hx-push-url="true"
        hx-select="#selected-contents"
        hx-swap="outerHTML"
        hx-target="#selected-contents"
        id="tree"
      >
        {% include "file_browser/tree.html" with path=root.fake_parent %}
      </ul>
    </div>
    <div class="browser__content">
      {% include "file_browser/contents.html" %}
    </div>
  </div>
{% endblock full_width_content %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'htmx-1.9.10.min.js' %}"></script>
  {% django_htmx_script %}
  <script src="{% static 'assets/file_browser/index.js' %}"></script>
{% endblock %}
