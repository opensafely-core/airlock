{% extends "base.html" %}

{% load static %}
{% load django_vite %}
{% load django_htmx %}

{% block metatitle %}{{ title }} |  Airlock{% endblock metatitle %}

{% block extra_styles %}
  <link rel="stylesheet" href="{% static 'assets/file_browser/index.css' %}">
  <style>
    .tree a.directory {
      background-image: url("{% static 'folder.png' %}");
    }
  </style>
{% endblock extra_styles %}

{% block content %}
  <div class="div flex flex-col items-start gap-2">
    {% airlock_header title=title %}

    <div class="flex items-center gap-2">
      {% if context == "request" %}
        {% if is_author %}
          {% if release_request.status.name == "PENDING" %}
            <form action="{{ request_submit_url }}" method="POST">
              {% csrf_token %}
              {% #button type="submit" tooltip="This request is ready to be reviewed" variant="success" class="action-button" id="submit-for-review-button" %}Submit For Review{% /button %}
            </form>
          {% elif release_request.status.name == "SUBMITTED" %}
            {% #modal id="withdrawRequest" button_text="Withdraw this request" variant="warning" %}
              {% #card container=True title="Withdraw this request" %}
                <form action="{{ request_withdraw_url }}" method="POST">
                  {% csrf_token %}

                  <div class="pb-8">
                    This will withdraw the entire request.
                    Once a request is withdrawn, it cannot be resubmitted and must be
                    recreated from scratch.
                    Please confirm you wish to withdraw this request.
                  </div>
                  {% #button type="submit" variant="danger" class="action-button" id="withdraw-request-confirm" %}Withdraw{% /button %}
                  {% #button variant="primary" type="cancel" %}Cancel{% /button %}
                </form>
              {% /card %}
            {% /modal %}
          {% endif %}
        {% elif is_output_checker %}
          {% if release_request.status.name == "SUBMITTED" %}
            <form action="{{ request_reject_url }}" method="POST">
              {% csrf_token %}
              {% #button type="submit" tooltip="Reject this request" variant="danger" class="action-button" id="reject-request-button" %}Reject Request{% /button %}
            </form>
            {% if release_request.all_files_approved %}
              <form action="{{ release_files_url }}" method="POST" hx-post="{{ release_files_url }}" hx-disabled-elt="button">
                {% csrf_token %}
                {% #button type="submit" tooltip="Release files to jobs.opensafely.org" variant="warning" id="release-files-button" %}Release Files{% icon_custom_spinner class="h-6 w-6 text-green-700 animate-spin stroke-current stroke-2 htmx-indicator" %}
                {% /button %}
              </form>
            {% else %}
              {% #button disabled=True tooltip="Releasing to jobs.opensafely.org is disabled until all files have been approved by two reviewers" variant="warning" id="release-files-button" %}Release Files{% /button %}
            {% endif %}
          {% endif %}
        {% endif %}
        {% #button type="link" href=workspace.get_url variant="success" id="workspace-home-button" %}Workspace Home{% /button %}
      {% elif current_request %}
        {% #button variant="success" type="link" href=current_request.get_url id="current-request-button" %}Current release request{% /button %}
      {% elif context == "request" or context == "workspace" %}
        {% #button type="link" href=workspace.get_requests_url variant="success" id="requests-workspace-button" %}All release requests for workspace{% /button %}
      {% endif %}
    </div>
  </div>
{% endblock content %}

{% block full_width_content %}
  <div class="browser">
    <div class="browser__files">
      <ul
        class="tree root"
        hx-boost="true"
        hx-on:htmx:after-request="setTreeSelection(this, event)"
        hx-push-url="true"
        hx-select="#selected-contents"
        hx-swap="outerHTML"
        hx-target="#selected-contents"
        id="tree"
      >
        {% include "file_browser/tree.html" with path=root.fake_parent %}
      </ul>
    </div>
    <div class="browser__content">
      {% include "file_browser/contents.html" %}
    </div>
  </div>
{% endblock full_width_content %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'htmx-1.9.10.min.js' %}"></script>
  {% django_htmx_script %}
  <script src="{% static 'assets/file_browser/index.js' %}"></script>
{% endblock %}
